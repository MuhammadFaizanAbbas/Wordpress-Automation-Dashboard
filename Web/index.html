<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Content OS | Automation Command Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sidebar-width: 260px; --primary-dark: #1a1d21; --accent: #0d6efd; --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; margin: 0; }
        
        /* Navigation Sidebar */
        #sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; background: var(--primary-dark); color: white; padding: 25px; z-index: 1000; transition: var(--transition); }
        #main-content { margin-left: var(--sidebar-width); padding: 40px; width: calc(100% - var(--sidebar-width)); min-height: 100vh; transition: var(--transition); position: relative; }

        /* Smooth Tab Animations */
        .tab-content { display: none; }
        .tab-content.active { display: block !important; animation: fadeInSlide 0.4s ease-out forwards; }

        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Skeleton Pulse Effect */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .skeleton { background: #e2e8f0; border-radius: 12px; animation: pulse 1.5s infinite ease-in-out; }
        .skeleton-card { height: 140px; width: 100%; margin-bottom: 20px; }
        .skeleton-chart { height: 350px; width: 100%; }
        .skeleton-article { height: 500px; width: 100%; margin-bottom: 30px; }

        .nav-link { color: #9ea7af; cursor: pointer; border-radius: 12px; margin-bottom: 8px; padding: 12px; display: block; text-decoration: none; transition: 0.3s; font-weight: 500; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { background: rgba(13, 110, 253, 0.15); color: white; border-left: 4px solid var(--accent); }

        /* Accordion Style History Rows */
        .history-row { cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #f0f0f0; }
        .history-row:hover { background: #f8fafc !important; }
        .expandable-content { 
            display: grid; 
            grid-template-rows: 0fr; 
            transition: grid-template-rows 0.4s ease-out; 
            background: #ffffff;
        }
        .expandable-content.show { grid-template-rows: 1fr; border-bottom: 2px solid var(--accent); }
        .expansion-wrapper { overflow: hidden; }
        .expansion-inner { padding: 30px; border-top: 1px solid #f0f0f0; background: #fff; }

        /* FIXED MOBILE VIEW: Bottom Nav */
        @media (max-width: 992px) {
            #sidebar { 
                width: 100%; 
                height: auto; 
                bottom: 0; 
                top: auto; 
                padding: 10px; 
                display: block; 
                border-top: 1px solid rgba(255,255,255,0.1);
                background: #111; /* Darker for better contrast on mobile */
            }
            #sidebar h3 { display: none; }
            .nav { 
                flex-direction: row !important; 
                width: 100%; 
                justify-content: space-between; 
                overflow-x: auto; 
                flex-wrap: nowrap; 
            }
            .nav-link { 
                margin-bottom: 0; 
                padding: 8px 12px; 
                font-size: 13px; 
                border-left: 0 !important; 
                flex: 1; 
                text-align: center;
                white-space: nowrap;
            }
            .nav-link.active { border-bottom: 3px solid var(--accent); border-radius: 0; }
            #main-content { margin-left: 0; width: 100%; padding: 20px; padding-bottom: 90px; }
            .badge { font-size: 0.7rem; vertical-align: middle; }
        }

        .stat-card { border: none; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.02); background: white; padding: 25px; }
        .card-review { border: none; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); background: white; overflow: hidden; margin-bottom: 30px; }
        
        .verdict-header { padding: 14px; font-weight: 700; text-align: center; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1.5px; }
        .verdict-ready { background: #e6fffa; color: #047481; }
        .verdict-fix { background: #fff5f5; color: #c53030; }

        .html-preview-box { background: #fafafa; border: 1px solid #f0f0f0; padding: 25px; border-radius: 16px; max-height: 500px; overflow-y: auto; color: #4a5568; line-height: 1.6; }
        .audit-pill { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; margin-bottom: 10px; font-weight: 600; font-size: 0.85rem; }
        .asset-scroll-box { max-height: 120px; overflow-y: auto; background: #fff; border: 1px solid #edf2f7; padding: 12px; border-radius: 12px; font-size: 0.8rem; }

        .empty-state { text-align: center; padding: 60px 20px; background: white; border-radius: 30px; border: 1px dashed #cbd5e0; }
        .empty-icon { font-size: 50px; display: block; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 class="mb-5 text-accent fw-bold text-center">CONTENT OS</h3>
    <nav class="nav flex-column">
        <a id="link-stats" class="nav-link active" onclick="showTab('tab-stats')">üìä Overview</a>
        <a id="link-review" class="nav-link" onclick="showTab('tab-review')">‚è≥ Queue <span id="badge-pending" class="badge bg-primary">0</span></a>
        <a id="link-history" class="nav-link" onclick="showTab('tab-history')">üìú History</a>
    </nav>
</div>

<div id="main-content">
    
    <div id="tab-stats" class="tab-content active">
        <div class="d-flex justify-content-between align-items-center mb-5 flex-wrap">
            <h1 class="fw-bold h2 mb-0">System Overview</h1>
            <button onclick="fetchData()" class="btn btn-dark rounded-pill px-4 shadow-sm">üîÑ Refresh Data</button>
        </div>

        <div id="stats-skeleton" class="row g-4 mb-5">
            <div class="col-md-4"><div class="skeleton skeleton-card"></div></div>
            <div class="col-md-4"><div class="skeleton skeleton-card"></div></div>
            <div class="col-md-4"><div class="skeleton skeleton-card"></div></div>
        </div>

        <div id="stats-real" class="row g-4 mb-5" style="display:none;">
            <div class="col-md-4"><div class="card stat-card"><h6 class="text-muted small fw-bold">PENDING</h6><h2 id="count-pending" class="fw-bold">0</h2></div></div>
            <div class="col-md-4"><div class="card stat-card text-success"><h6 class="small fw-bold">APPROVED</h6><h2 id="count-approved" class="fw-bold">0</h2></div></div>
            <div class="col-md-4"><div class="card stat-card text-danger"><h6 class="small fw-bold">REJECTED</h6><h2 id="count-rejected" class="fw-bold">0</h2></div></div>
        </div>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card p-4 border-0 shadow-sm rounded-4 h-100">
                    <h5 class="fw-bold mb-4">Pipeline Distribution</h5>
                    <div id="chart-skeleton" class="skeleton skeleton-chart"></div>
                    <canvas id="statusChart" style="display:none"></canvas>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card p-4 border-0 shadow-sm rounded-4 bg-primary text-white h-100 d-flex flex-column align-items-center justify-content-center text-center">
                    <h3 class="fw-bold mb-3">AI Verdict Engine</h3>
                    <p class="opacity-75">Dashboards are automatically updated via n8n webhook signals from Google Sheets.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-review" class="tab-content">
        <h2 class="fw-bold mb-4">Pending Approval</h2>
        <div id="review-skeleton"><div class="skeleton skeleton-article"></div></div>
        <div id="pending-list"></div>
    </div>

    <div id="tab-history" class="tab-content">
        <h2 class="fw-bold mb-4">Master History</h2>
        <div id="history-container" class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-muted small text-uppercase">
                        <tr>
                            <th class="ps-4 py-3">Posted Date</th>
                            <th>Article</th>
                            <th>Status</th>
                            <th class="text-end pe-4">Details</th>
                        </tr>
                    </thead>
                    <tbody id="history-table"></tbody>
                </table>
            </div>
        </div>
        <div id="history-empty-placeholder"></div>
    </div>
</div>

<script>
    const GET_API = "https://arishkhan.app.n8n.cloud/webhook/c5c02f8c-e778-4c2d-a612-6712ba77fcf4";
    const POST_API = "https://arishkhan.app.n8n.cloud/webhook/91398f32-64a8-409b-a183-6d801b3900cd";
    let chartInstance = null;

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => {
            t.classList.remove('active');
            t.style.display = 'none';
        });
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        
        const activeTab = document.getElementById(tabId);
        activeTab.style.display = 'block';
        setTimeout(() => activeTab.classList.add('active'), 10);
        document.getElementById('link-' + tabId.split('-')[1]).classList.add('active');
        window.scrollTo(0, 0);
    }

    async function fetchData() {
        toggleUIState(false);
        try {
            const res = await fetch(GET_API);
            if (!res.ok) throw new Error("API Offline");
            const data = await res.json();
            renderUI(data);
        } catch (e) {
            renderEmptyState("pending-list", "üìÅ", "Connection Error", "Check n8n.");
            toggleUIState(true);
        }
    }

    function toggleUIState(isLoaded) {
        document.getElementById('stats-skeleton').style.display = isLoaded ? 'none' : 'flex';
        document.getElementById('stats-real').style.display = isLoaded ? 'flex' : 'none';
        document.getElementById('chart-skeleton').style.display = isLoaded ? 'none' : 'block';
        document.getElementById('statusChart').style.display = isLoaded ? 'block' : 'none';
        document.getElementById('review-skeleton').style.display = isLoaded ? 'none' : 'block';
    }

    function formatAssets(str) {
        if (!str || String(str).trim() === "" || str === "undefined") return '<span class="text-muted small">None found</span>';
        return String(str).split(',').map(item => {
            const val = item.trim();
            if (val.startsWith('http')) {
                return `<a href="${val}" target="_blank" class="text-truncate d-block mb-1 text-primary small" style="max-width:100%">${val}</a>`;
            }
            return `<span class="badge bg-light text-dark border me-1 mb-1">${val}</span>`;
        }).join('');
    }

    function renderEmptyState(targetId, icon, title, msg) {
        const container = document.getElementById(targetId);
        container.innerHTML = `<div class="empty-state my-4"><span class="empty-icon">${icon}</span><h3 class="fw-bold h5">${title}</h3><p class="text-muted small">${msg}</p></div>`;
    }

    function toggleHistory(rowId) {
        const content = document.getElementById(`history-expand-${rowId}`);
        const isShowing = content.classList.contains('show');
        document.querySelectorAll('.expandable-content').forEach(el => el.classList.remove('show'));
        if (!isShowing) content.classList.add('show');
    }

    function renderUI(articles) {
        const pendingList = document.getElementById('pending-list');
        const historyTable = document.getElementById('history-table');
        const historyContainer = document.getElementById('history-container');
        const historyEmptyPlaceholder = document.getElementById('history-empty-placeholder');
        
        let counts = { Pending: 0, Posted: 0, Rejected: 0 };
        pendingList.innerHTML = '';
        historyTable.innerHTML = '';

        if (!articles || articles.length === 0) {
            renderEmptyState("pending-list", "‚ú®", "No Data", "Check Google Sheets.");
            historyContainer.style.display = 'none';
            renderEmptyState("history-empty-placeholder", "üìú", "Empty", "No history found.");
            toggleUIState(true);
            return;
        }

        articles.forEach((art, index) => {
            const currentStatus = art.status || art["Approval Status"] || "Pending";
            if(counts[currentStatus] !== undefined) counts[currentStatus]++;
            
            if (currentStatus === "Pending") {
                const isApproved = art.image_info?.includes('‚úÖ') && art.link_info?.includes('‚úÖ');
                pendingList.innerHTML += `
                    <div class="card card-review">
                        <div class="verdict-header ${isApproved ? 'verdict-ready' : 'verdict-fix'}">
                            ${isApproved ? '‚úî Ready' : '‚úò Needs Optimization'}
                        </div>
                        <div class="p-4"><div class="row g-4">
                            <div class="col-lg-8">
                                <h2 class="fw-bold h4 text-dark mb-2">${art.wp_title || 'Untitled'}</h2>
                                <p class="text-muted small mb-4"><strong>Meta:</strong> ${art.wp_meta_title}</p>
                                <div class="html-preview-box">${art.wp_content_html}</div>
                            </div>
                            <div class="col-lg-4 border-start ps-lg-4">
                                <h6 class="fw-bold text-uppercase small text-muted mb-3">Compliance Audit</h6>
                                <div class="small text-muted mb-1 fw-bold">IMAGES</div><div class="audit-pill">${art.image_info}</div>
                                <div class="small text-muted mb-1 fw-bold">LINKS</div><div class="audit-pill">${art.link_info}</div>
                                <div class="small text-muted mb-1 fw-bold">HOSTING</div><div class="audit-pill small">${art.hosting_info}</div>
                                <hr class="my-4">
                                <h6 class="fw-bold text-uppercase small text-muted mb-2">üè∑Ô∏è TAGS</h6><div class="mb-3">${formatAssets(art.Tags || art.tags)}</div>
                                <h6 class="fw-bold text-uppercase small text-muted mb-2">üñºÔ∏è ASSETS</h6><div class="asset-scroll-box mb-3">${formatAssets(art.Images || art.images)}</div>
                                <h6 class="fw-bold text-uppercase small text-muted mb-2">üîó LINKS</h6><div class="asset-scroll-box mb-4">${formatAssets(art.Links || art.links)}</div>
                                <button onclick="handleAction(${art.rowId}, 'Approved', this)" class="btn btn-success btn-lg w-100 rounded-4 shadow-sm mb-2">üöÄ Approve & Post</button>
                                <button onclick="handleAction(${art.rowId}, 'Rejected', this)" class="btn btn-outline-danger w-100 rounded-4 border-0">‚úñ Reject</button>
                            </div>
                        </div></div>
                    </div>`;
            } else {
                const pillClass = currentStatus === 'Posted' ? 'bg-success' : 'bg-danger';
                historyTable.innerHTML += `
                    <tr class="history-row" onclick="toggleHistory(${index})">
                        <td class="ps-4 text-muted small">${art.posted_date || '-'}</td>
                        <td class="fw-bold">${art.wp_title || 'Untitled'}</td>
                        <td><span class="badge rounded-pill ${pillClass}">${currentStatus}</span></td>
                        <td class="text-end pe-4 text-primary small fw-bold">VIEW DETAILS ‚ñæ</td>
                    </tr>
                    <tr>
                        <td colspan="4" class="p-0 border-0">
                            <div id="history-expand-${index}" class="expandable-content">
                                <div class="expansion-wrapper">
                                    <div class="expansion-inner">
                                        <div class="row g-4">
                                            <div class="col-xl-9">
                                                <h6 class="fw-bold text-uppercase text-muted small mb-3">Full Article Preview</h6>
                                                <div class="history-preview-box">${art.wp_content_html}</div>
                                            </div>
                                            <div class="col-xl-3">
                                                <h6 class="fw-bold text-uppercase text-muted small mb-3">Assets</h6>
                                                <div class="p-3 bg-light rounded-4">
                                                    <p class="small mb-3"><strong>Meta Title:</strong><br>${art.wp_meta_title}</p>
                                                    <p class="small mb-3"><strong>Tags:</strong><br>${formatAssets(art.Tags)}</p>
                                                    <p class="small mb-0"><strong>Links:</strong><br>${formatAssets(art.Links)}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>`;
            }
        });

        if (counts.Pending === 0) renderEmptyState("pending-list", "‚ú®", "Queue Clear", "No items pending review.");
        if (historyTable.innerHTML === "") {
            historyContainer.style.display = 'none';
            renderEmptyState("history-empty-placeholder", "üìú", "History Clean", "No processed articles.");
        } else {
            historyContainer.style.display = 'block';
        }

        document.getElementById('count-pending').innerText = counts.Pending;
        document.getElementById('count-approved').innerText = counts.Posted;
        document.getElementById('count-rejected').innerText = counts.Rejected;
        document.getElementById('badge-pending').innerText = counts.Pending;
        toggleUIState(true);
        updateChart(counts);
    }

    async function handleAction(rowId, action, btn) {
        if(!confirm(`Submit as ${action}?`)) return;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Syncing...`;
        await fetch(POST_API, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ rowId, action }) });
        setTimeout(() => fetchData(), 9000);
    }

    function updateChart(counts) {
        const ctx = document.getElementById('statusChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: ['Pending', 'Approved', 'Rejected'], datasets: [{ data: [counts.Pending, counts.Posted, counts.Rejected], backgroundColor: ['#0d6efd', '#198754', '#dc3545'], borderWidth: 0 }] },
            options: { cutout: '82%', plugins: { legend: { position: 'bottom' } } }
        });
    }

    window.onload = fetchData;
</script>
</body>
</html>

